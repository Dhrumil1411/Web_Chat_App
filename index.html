<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Web Chat App</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="massage.png" />
    <style>
      .inputForUserName {
        height: 5%;
        width: auto;
        border-radius: 10px;
        border: 1px solid black;
        padding: 10px;
        margin-top: 30px;
        margin-bottom: 10px;
      }

      .signIn {
        height: 5%;
        width: auto;
        min-width: 15%;
        margin: 5px;
        border: 1px solid black;
        padding: 5px;
        border-radius: 10px;
        color: black;
        font-family: Arial;
        margin-bottom: 10px;
      }

      .signIn:hover {
        cursor: pointer;
      }

      .signUp {
        height: 5%;
        width: auto;
        min-width: 15%;
        margin: 5px;
        border: 1px solid black;
        padding: 5px;
        border-radius: 10px;
        color: black;
        font-family: Arial;
        margin-bottom: 10px;
      }

      .signUp:hover {
        cursor: pointer;
      }

      .inputForMessage {
        height: 5%;
        width: 80%;
        min-width: auto;
        border-radius: 10px;
        border: 2px solid black;
        padding: 5px;
      }

      .messageBtn {
        height: 5%;
        width: auto;
        min-width: 10%;
        margin: 5px;
        border: 2px solid black;
        padding: 5px;
        border-radius: 10px;
        color: black;
        font-family: Arial;
      }

      .messageBtn:hover {
        cursor: pointer;
      }

      .chatsGet {
        font-size: 17px;
        color: black;
        margin-bottom: 4px;
        border-radius: 7px;
        padding-top: 3px;
        padding-bottom: 3px;
        letter-spacing: 1px;
        border: 1px solid black;
        display: inline-block;
        word-wrap: break-word;
        max-width: 60%;
      }

      .chatsSend {
        display: inline-block;
        font-size: 17px;
        color: black;
        margin-bottom: 4px;
        border-radius: 7px;
        padding-top: 3px;
        padding-bottom: 3px;
        letter-spacing: 1px;
        border: 1px solid black;
        word-wrap: break-word;
        max-width: 60%;
      }

      .allChats {
        width: auto;
        height: auto;
        border: 1px solid black;
        border-radius: 10px;
        padding-right: 10px;
        padding-left: 10px;
        overflow-y: auto;
        overflow-x: hidden;
        height: 70vh;
        display: block;
      }

      .userNameHead {
        height: 100%;
        width: 100%;
        padding-top: 180px;
        padding-bottom: 175px;
      }

      .inputForGroupName {
        height: 5%;
        width: auto;
        border-radius: 10px;
        border: 1px solid;
        padding: 5px;
      }

      .groupBtn {
        height: 5%;
        width: auto;
        min-width: 15%;
        margin: 5px;
        border: 2px solid black;
        padding: 5px;
        border-radius: 10px;
        color: black;
        font-family: Arial;
      }

      .groupBtn:hover {
        cursor: pointer;
      }

      .groups {
        height: 5%;
        width: auto;
        min-width: 15%;
        border: 2px solid black;
        padding: 5px 10px 5px 10px;
        border-radius: 10px;
        color: black;
        font-family: Arial;
        margin-right: 5px;
        height: 30px;
      }

      .groups:hover {
        cursor: pointer;
      }

      .groupSelected {
        background-color: black;
        color: white;
        height: 5%;
        width: auto;
        min-width: 15%;
        border: 2px solid white;
        padding: 5px 10px 5px 10px;
        border-radius: 10px;
        font-family: Arial;
        margin-right: 5px;
        height: 30px;
      }

      .formArea {
        padding-top: 30px;
        border-radius: 20px;
        width: auto;
        min-width: 40%;
        border: 5px solid black;
        text-align: center;
        font-size: 20px;
        font-family: arial;
        font-weight: bold;
        color: black;
        margin-left: 20%;
        margin-right: 20%;
      }

      .groupAdderBtn {
        height: 5%;
        width: auto;
        margin: 5px;
        border: 2px solid black;
        padding: 5px;
        border-radius: 10px;
        color: black;
        font-family: Arial;
      }

      .groupAdderBtn:hover {
        cursor: pointer;
      }

      .groupCencel {
        height: 5%;
        width: auto;
        min-width: 15%;
        margin: 5px;
        border: 2px solid black;
        padding: 5px;
        border-radius: 10px;
        color: black;
        font-family: Arial;
      }

      .groupCencel:hover {
        cursor: pointer;
      }

      .groupsAndChats {
        width: auto;
        height: auto;
      }

      body {
        margin: 5px;
      }

      .password {
        height: 5%;
        width: auto;
        border-radius: 10px;
        border: 1px solid black;
        padding: 10px;
        margin-bottom: 20px;
      }

      .changeUser {
        height: 5%;
        width: auto;
        margin: 5px;
        border: 2px solid black;
        padding: 5px;
        border-radius: 10px;
        color: black;
        font-family: Arial;
      }

      .changeUser:hover {
        cursor: pointer;
      }

      .inChatName {
        font-size: 12px;
        font-family: Arial;
        font-weight: 1000;
        line-height: 8px;
        margin: 5px;
      }

      .text {
        margin-top: 3px;
        margin-bottom: 3px;
        margin-right: 20px;
        margin-left: 20px;
        word-wrap: break-word;
      }

      .chatsAfterGroupSelect {
        margin: 10px;
      }

      @media screen and (max-width: 992px) {
        .groupAdderBtn {
          width: 97%;
        }

        .changeUser {
          width: 97%;
        }

        .groupHead {
          text-align: center;
        }

        .groupfooter {
          text-align: center;
        }

        .allChats {
          height: 75vh;
        }
      }

      .groupsList {
        border: 1px solid black;
        width: auto;
        height: auto;
        margin-right: 5px;
        margin-left: 5px;
        overflow-y: hidden;
        overflow-x: auto;
        margin-top: 10px;
        padding: 5px 10px 5px 10px;
        border-radius: 10px;
        text-wrap: nowrap;
      }

      .chatSelect {
        display: none;
      }

      .time {
        font-size: 11px;
        margin: 0px;
        margin-right: 5px;
        font-weight: 800;
        font-family: arial;
      }

      .date {
        border: 1px solid black;
        color: black;
        border-radius: 10px;
        text-align: center;
        width: fit-content;
        text-align: center;
        padding: 5px 10px 5px 10px;
        margin-left: auto;
        margin-right: auto;
      }

      .googleLoginBtn {
        border-radius: 20px;
        border: 1px solid black;
        text-align: center;
        margin: 5px;
        margin-bottom: 10px;
        padding: 5px;
      }

      .googleLoginBtn:hover {
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="userNameHead" class="userNameHead" style="display: none">
      <div class="formArea">
        Login
        <form id="userNameForm">
          <input
            type="text"
            id="inputForUserName"
            class="inputForUserName"
            placeholder="Enter Your Username...."
            autofocus
            autocomplete="off"
          /><br />
          <input
            type="password"
            id="password"
            class="password"
            placeholder="Enter password...."
            pattern=".{8,}"
            required
            autocomplete="off"
          /><br />
          <button type="button" id="signIn" class="signIn">SIGN IN</button>
          <button type="button" id="signUp" class="signUp">SIGN UP</button
          ><br />
          <button type="button" id="googleLoginBtn" class="googleLoginBtn">
            <img
              width="20"
              height="20"
              src="https://img.icons8.com/color/48/google-logo.png"
              alt="google-logo"
              style="float: left; margin-right: 7px"
            />
            <p style="float: left; margin: 1px; font-size: 15px">
              Sign In With Google
            </p>
          </button>
        </form>
      </div>
    </div>

    <div id="groupsAndChats" class="groupsAndChats" style="display: none">
      <div id="groupAddBtn">
        <button type="button" class="groupAdderBtn" id="groupAdderBtn">
          Add New Group
        </button>
        <button type="button" id="changeUser" class="changeUser">
          Sign Out
        </button>
      </div>
      <div id="groupAdder" class="groupAdder">
        <form id="groupForm">
          <input
            id="inputForGroupName"
            class="inputForGroupName"
            placeholder="Enter Group Name......."
            type="text"
            autocomplete="off"
          />
          <button type="button" class="groupBtn" id="groupBtn">
            Add Group
          </button>
          <button type="button" class="groupCencel" id="groupCencel">
            Cancel
          </button>
        </form>
      </div>
      <div id="groupNames" style="display: block">
        <p
          style="
            font-family: arial;
            font-size: 17px;
            font-weight: bolder;
            margin: 5px;
            margin-top: 10px;
          "
          class="groupHead"
        >
          CHAT GROUPS :
        </p>
        <div id="groupsList" class="groupsList"></div>
      </div>
      <p
        style="font-family: arial; font-size: 17px; font-weight: bolder"
        id="selectGroup"
        class="groupfooter"
      >
        Please Select Or Create A Group!
      </p>

      <div
        id="chatsAfterGroupSelect"
        style="display: none"
        class="chatsAfterGroupSelect"
      >
        <div class="allChats" id="" allChats>
          <ul
            id="chatArea"
            style="list-style: none; font-family: sans-serif; padding-left: 0px"
          ></ul>
        </div>

        <div>
          <form id="messageForm" class="messageForm">
            <input
              type="text"
              class="inputForMessage"
              id="inputForMessage"
              placeholder="Message"
              autocomplete="off"
            />
            <button type="button" class="messageBtn" id="messageBtn">
              Send
            </button>
          </form>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";

      import {
        getDatabase,
        set,
        get,
        ref,
        remove,
        child,
        update,
        push,
        onValue,
        query,
        onChildAdded,
        off,
      } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";

      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB-r_eRpmJCAhjcwZiSKUy2QZlegPUCdNE",
        authDomain: "chat-application-8e9ce.firebaseapp.com",
        databaseURL:
          "https://chat-application-8e9ce-default-rtdb.firebaseio.com",
        projectId: "chat-application-8e9ce",
        storageBucket: "chat-application-8e9ce.appspot.com",
        messagingSenderId: "356463502797",
        appId: "1:356463502797:web:642f8a38037347dafdd084",
      };

      // Initialize Firebase

      const app = initializeApp(firebaseConfig);
      const database = getDatabase();
      const onValueRef = query(ref(database, "groups/"));
      const provider = new GoogleAuthProvider();
      const auth = getAuth(app);

      //script codes

      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("userNameHead").style.display = "none";
          document.getElementById("groupsAndChats").style.display = "block";
          localStorage.setItem("userName", JSON.stringify(user.displayName));
        } else {
          document.getElementById("groupsAndChats").style.display = "none";
          document.getElementById("userNameHead").style.display = "block";
        }
      });

      const userSignedIn = async () => {
        signInWithPopup(auth, provider)
          .then((result) => {
            const credential = GoogleAuthProvider.credentialFromResult(result);
            const token = credential.accessToken;
            const user = result.user;
            console.log(user);
          })
          .catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;
          });
      };

      document
        .getElementById("googleLoginBtn")
        .addEventListener("click", userSignedIn);

      let click = document.getElementById("inputForMessage");
      click.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          document.getElementById("messageBtn").click();
        }
      });

      let click2 = document.getElementById("inputForGroupName");
      click2.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          document.getElementById("groupBtn").click();
        }
      });

      document.getElementById("groupAdder").style.display = "none";
      document.getElementById("groupAdderBtn").addEventListener("click", () => {
        document.getElementById("groupAddBtn").style.display = "none";
        document.getElementById("groupAdder").style.display = "block";
        document.getElementById("inputForGroupName").focus();
      });

      document.getElementById("groupCencel").addEventListener("click", () => {
        document.getElementById("groupAddBtn").style.display = "block";
        document.getElementById("groupAdder").style.display = "none";
      });

      const dbref = ref(database);
      let user = JSON.parse(localStorage.getItem("userName"));
      let pw = JSON.parse(localStorage.getItem("password"));

      if (user !== null || pw !== null) {
        get(child(dbref, "users/" + user)).then((snapshot) => {
          let data = snapshot.val();
          if (snapshot.exists()) {
            document.getElementById("groupsAndChats").style.display = "block";
          }
        });
      } else {
        document.getElementById("userNameHead").style.display = "block";
        document.getElementById("inputForUserName").focus();
      }

      const userSignedOut = async () => {
        signOut(auth)
          .then(() => {
            document.getElementById("inputForUserName").value = "";
            document.getElementById("password").value = "";
            console.log(selectedgroup);
            selectedgroup = null;
            user = null;
            console.log(user);
            pw = null;
            console.log(pw);
            localStorage.setItem("userName", JSON.stringify(user));
            localStorage.setItem("password", JSON.stringify(pw));
            location.reload();
            document.getElementById("inputForUserName").focus();
          })
          .catch((error) => {});
      };

      document
        .getElementById("changeUser")
        .addEventListener("click", userSignedOut);

      document.getElementById("signIn").addEventListener("click", function () {
        console.log("in signIn");
        let username = document.getElementById("inputForUserName").value;
        console.log(username);
        get(child(dbref, "users/" + username)).then((snapshot) => {
          let data = snapshot.val();
          if (snapshot.exists()) {
            if (data.password === document.getElementById("password").value) {
              localStorage.setItem(
                "userName",
                JSON.stringify(
                  document.getElementById("inputForUserName").value
                )
              );
              localStorage.setItem(
                "password",
                JSON.stringify(document.getElementById("password").value)
              );
              document.getElementById("userNameHead").style.display = "none";
              document.getElementById("groupsAndChats").style.display = "block";
            } else {
              alert("Incorrect Password.");
            }
          } else {
            alert("User Doesn't Exist.");
          }
        });
      });

      document.getElementById("signUp").addEventListener("click", function () {
        console.log("In SignUp");
        get(
          child(
            dbref,
            "users/" + document.getElementById("inputForUserName").value
          )
        ).then((snapshot) => {
          console.log(snapshot.val());
          if (snapshot.exists()) {
            alert("User Already Exists.");
          } else {
            localStorage.setItem(
              "userName",
              JSON.stringify(document.getElementById("inputForUserName").value)
            );
            localStorage.setItem(
              "password",
              JSON.stringify(document.getElementById("password").value)
            );
            console.log("Username Entered Successfully");
            document.getElementById("userNameHead").style.display = "none";
            set(
              ref(
                database,
                "users/" + document.getElementById("inputForUserName").value
              ),
              {
                userName: document.getElementById("inputForUserName").value,
                password: document.getElementById("password").value,
              }
            );
            document.getElementById("userNameHead").style.display = "none";
            document.getElementById("groupsAndChats").style.display = "block";
          }
        });
      });

      document
        .getElementById("groupBtn")
        .addEventListener("click", function () {
          if (document.getElementById("inputForGroupName").value === "") {
            alert("Please Enter Group Name.");
          } else {
            let id = Math.floor(Math.random() * 9999);
            set(ref(database, "groups/" + id + "/"), {
              groupName: document.getElementById("inputForGroupName").value,
              id: id,
            });
            console.log("Group Entered Successfully");
            document.getElementById("inputForGroupName").value = "";
          }
          document.getElementById("groupAdder").style.display = "none";
          document.getElementById("groupAddBtn").style.display = "block";
        });

      onChildAdded(
        onValueRef,
        (snapshot) => {
          console.log(snapshot.val());
          let data = snapshot.val();
          let group = data.groupName;
          let groupName = document.createElement("button");
          groupName.setAttribute("type", "button");
          groupName.setAttribute("id", data.id);
          groupName.addEventListener("click", () => {
            messages(data.id);
            document.getElementById("inputForMessage").focus();
          });
          groupName.setAttribute("class", "groups");
          groupName.innerHTML = group;
          document.getElementById("groupsList").appendChild(groupName);
          document.getElementById("inputForMessage").focus();
        },
        (errorObject) => {
          console.log("The read failed: " + errorObject.name);
        }
      );

      let selectedgroup = null;
      let onvalref = null;
      let dateDisplayed = false;
      let todayDate = new Date().toDateString();

      function messages(id) {
        let onvalref = query(ref(database, "groups/" + id + "/chats/"));

        if (onvalref) {
          off(onvalref);
        }
        document.getElementById("chatArea").innerHTML = "";
        selectedgroup = id;
        let isDateShowed = null;
        onChildAdded(onvalref, (snapshot) => {
          let data = snapshot.val();
          let chat = document.createElement("li");
          let message = document.createElement("div");
          let inChatName = document.createElement("p");
          let chats = document.createElement("p");
          let chatTime = document.createElement("p");
          chatTime.classList.add("time");
          chats.classList.add("text");
          inChatName.classList.add("inChatName");
          let userName = JSON.parse(localStorage.getItem("userName"));
          if (userName === data.username) {
            message.classList.add("chatsGet");
            chat.setAttribute("style", "text-align:right;");
          } else {
            message.classList.add("chatsSend");
            chat.setAttribute("style", "text-align:left;");
          }
          let name = document.createTextNode(data.username);
          inChatName.appendChild(name);
          let text = document.createTextNode(data.message);
          chats.appendChild(text);
          let time = document.createTextNode(data.hour + ":" + data.minute);
          chatTime.appendChild(time);
          message.appendChild(inChatName);
          message.appendChild(chats);
          message.appendChild(chatTime);
          chat.scrollIntoView({ behavior: "smooth" });
          chat.appendChild(message);
          let date = document.createElement("p");
          date.classList.add("date");
          let Date = document.createTextNode(data.date);
          date.appendChild(Date);
          if (isDateShowed !== data.date || isDateShowed === null) {
            document.getElementById("chatArea").appendChild(date);
            isDateShowed = data.date;
            console.log(isDateShowed);
          }
          document.getElementById("chatArea").appendChild(chat);
          let lastChat = document.getElementById("chatArea").lastChild;
          lastChat.scrollIntoView({ behavior: "smooth" });
        }),
          (document.getElementById("selectGroup").style.display = "none");
        document.getElementById("chatsAfterGroupSelect").style.display =
          "block";
        document.getElementById("inputForMessage").focus();
        document.getElementById("chatArea").scrollTop =
          document.getElementById("chatArea").scrollHeight;
      }

      document
        .getElementById("groupsList")
        .addEventListener("click", (event) => {
          if (event.target.classList.contains("groups")) {
            let groupId = event.target.id;
            messages(groupId);
            document.getElementById("inputForMessage").focus();
          }
        });

      document
        .getElementById("messageBtn")
        .addEventListener("click", function (id) {
          let message = document.getElementById("inputForMessage").value;
          let userName = JSON.parse(localStorage.getItem("userName"));
          let time = new Date();
          let hour = time.getHours();
          let minute = time.getMinutes();
          let date = time.toLocaleDateString();
          time.getMinutes();
          if (message !== "") {
            push(ref(database, "groups/" + selectedgroup + "/chats/"), {
              message: message,
              username: userName,
              hour: hour,
              minute: minute,
              date: date,
            });
          }
          console.log("message Entered Successfully");
          document.getElementById("inputForMessage").value = "";
          document.getElementById("inputForMessage").focus();
        });
    </script>
  </body>
</html>